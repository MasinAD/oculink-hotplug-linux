#!/bin/bash
# OCuLink GPU Toggle Tool - Safe removal and reconnection

LOCKFILE="/tmp/oculink-gpu-removal.lock"

send_notification() {
    local title="$1"
    local message="$2"
    local urgency="${3:-normal}"
    
    notify-send --urgency="$urgency" --app-name="OCuLink GPU" "$title" "$message" 2>/dev/null || true
    echo "üîî $title: $message"
}

echo "üîå OCuLink GPU Toggle Tool"
echo "=========================="

# Check monitor status
monitor_status=$(/usr/local/bin/oculink-reconnect-monitor status 2>/dev/null || echo "INACTIVE")
removal_watcher_active=$([ -f "/tmp/oculink-removal-watcher.pid" ] && echo "ACTIVE" || echo "INACTIVE")

if [[ "$removal_watcher_active" == "ACTIVE" ]]; then
    echo "üëÄ Stage 1: Waiting for physical GPU removal..."
    echo
elif [[ "$monitor_status" != "INACTIVE" ]]; then
    echo "üîÑ Stage 2: Smart reconnection monitoring active"
    echo "   $monitor_status"
    echo
fi

echo

# Check if removal is in progress
if [ -f "$LOCKFILE" ] || [[ "$removal_watcher_active" == "ACTIVE" ]]; then
    send_notification "GPU Ready" "OCuLink GPU is safe to unplug now!" "critical"
    echo "üîÑ GPU removal in progress..."
    echo "   GPU should be safe to unplug now!"
    echo
    read -p "üìå Cancel removal and clear state? [y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Clean up all removal-related processes and files
        rm -f "$LOCKFILE"
        
        # Kill removal watcher if active
        if [ -f "/tmp/oculink-removal-watcher.pid" ]; then
            local watcher_pid=$(cat /tmp/oculink-removal-watcher.pid 2>/dev/null || echo "")
            if [ -n "$watcher_pid" ]; then
                kill "$watcher_pid" 2>/dev/null || true
            fi
            rm -f /tmp/oculink-removal-watcher.pid
        fi
        
        # Stop reconnection monitor if active
        /usr/local/bin/oculink-reconnect-monitor stop 2>/dev/null || true
        
        send_notification "Cancelled" "GPU removal cancelled - all monitoring stopped" "normal"
        echo "‚úÖ Removal cancelled and state cleared."
    fi
    exit 0
fi

# Check if GPU is present - ONLY discrete OCuLink GPUs, exclude integrated
gpu_count=$(lspci | grep -i "amd.*vga" | grep -v -i "hawkpoint\|radeon.*[0-9][0-9][0-9][0-9]G\|vega.*[0-9]" | wc -l)
discrete_gpu=$(lspci | grep -i "amd.*vga" | grep -v -i "hawkpoint\|radeon.*[0-9][0-9][0-9][0-9]G\|vega.*[0-9]" | head -1)

if [ "$gpu_count" -gt 0 ] && [ -n "$discrete_gpu" ]; then
    # GPU present - offer removal
    send_notification "GPU Detected" "OCuLink GPU found - preparing for safe removal" "normal"
    echo "üîç Detected discrete GPU:"
    echo "   $discrete_gpu"
    echo
    read -p "‚ö†Ô∏è  Safely prepare GPU for removal? [y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        send_notification "Cancelled" "GPU removal cancelled by user" "normal"
        echo "‚ùå Cancelled."
        exit 0
    fi
    
    send_notification "Preparing Removal" "Stopping processes and unloading drivers..." "critical"
    echo "üîÑ Preparing GPU for safe removal..."
    echo "   ‚Ä¢ Stopping GPU-intensive processes"
    echo "   ‚Ä¢ Unloading drivers"  
    echo "   ‚Ä¢ Disconnecting PCIe device"
    echo
    
    # Call the manager script
    /usr/local/bin/oculink-gpu-manager manual-safe-remove
    
    send_notification "Safe to Unplug!" "OCuLink GPU is now safe to remove" "critical"
    echo "‚úÖ GPU is now safe to unplug!"
    echo "   You should see a notification when ready."
    
elif [ "$gpu_count" -eq 0 ]; then
    # No discrete GPU - trigger rescan for reconnection
    send_notification "Scanning..." "Looking for reconnected OCuLink GPU" "normal"
    echo "üîç Only integrated GPU detected."
    echo "   Scanning for reconnected OCuLink GPU..."
    echo
    
    # Rescan PCI bus
    echo 1 > /sys/bus/pci/rescan 2>/dev/null || {
        send_notification "Permission Error" "Need root access for PCI rescan" "critical"
        echo "‚ö†Ô∏è  Need root permissions for PCI rescan"
        echo "   Run: sudo sh -c 'echo 1 > /sys/bus/pci/rescan'"
        exit 1
    }
    
    sleep 2
    
    # Check if GPU reappeared - only discrete GPUs
    new_gpu=$(lspci | grep -i "amd.*vga" | grep -v -i "hawkpoint\|radeon.*[0-9][0-9][0-9][0-9]G\|vega.*[0-9]")
    if [ -n "$new_gpu" ]; then
        send_notification "GPU Connected!" "OCuLink GPU detected and initializing..." "normal"
        echo "‚úÖ OCuLink GPU reconnected!"
        echo "   $new_gpu"
        
        # Reload driver if needed
        if ! lsmod | grep -q "amdgpu"; then
            send_notification "Loading Driver" "Initializing GPU driver..." "normal"
            echo "üîÑ Loading GPU driver..."
            modprobe amdgpu 2>/dev/null || {
                send_notification "Driver Error" "Could not load amdgpu driver" "critical"
                echo "‚ö†Ô∏è  Could not load amdgpu driver"
            }
        fi
        
        # Restart compositor if needed
        if ! pgrep -x "Hyprland" > /dev/null; then
            send_notification "Restarting Display" "Restarting Hyprland compositor..." "normal"
            echo "üîÑ Restarting Hyprland..."
            setsid Hyprland > /dev/null 2>&1 &
        fi
        
        # Final success notification
        send_notification "GPU Ready!" "OCuLink GPU is ready to use!" "normal"
        
    else
        send_notification "GPU Not Found" "No OCuLink GPU detected - check connection" "critical"
        echo "‚ùå No OCuLink GPU detected."
        echo "   Make sure GPU is properly connected."
    fi
    
else
    send_notification "No GPU Found" "Connect your OCuLink GPU and try again" "normal"
    echo "‚ùå No AMD GPU detected."
    echo "   Connect your OCuLink GPU and try again."
fi